<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ultimate Snake Game</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: linear-gradient(135deg, #0a1428, #1e3a5f, #2d5aa0);
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #e0f2ff;
        overflow: hidden;
        min-height: 100vh;
        animation: backgroundShift 10s ease-in-out infinite;
      }

      @keyframes backgroundShift {
        0%,
        100% {
          background: linear-gradient(135deg, #0a1428, #1e3a5f, #2d5aa0);
        }
        50% {
          background: linear-gradient(135deg, #0d1b3a, #2547a8, #4169e1);
        }
      }

      #title {
        font-size: 2.5em;
        font-weight: bold;
        margin: 20px 0 10px 0;
        text-shadow: 0 0 20px #4169e1, 0 0 40px #1e90ff;
        animation: glow 2s ease-in-out infinite alternate;
      }

      @keyframes glow {
        from {
          text-shadow: 0 0 20px #4169e1, 0 0 40px #1e90ff;
        }
        to {
          text-shadow: 0 0 30px #4169e1, 0 0 60px #1e90ff, 0 0 80px #00bfff;
        }
      }

      #difficultySelector {
        margin: 10px 0;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      #difficultySelector label {
        font-size: 18px;
        font-weight: bold;
      }

      #difficultySelector select {
        padding: 8px 12px;
        font-size: 16px;
        background: rgba(30, 144, 255, 0.2);
        color: #e0f2ff;
        border: 2px solid #4169e1;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #difficultySelector select:hover {
        background: rgba(30, 144, 255, 0.4);
        box-shadow: 0 0 15px rgba(65, 105, 225, 0.5);
      }

      #scoreBoard {
        display: flex;
        justify-content: space-between;
        width: 460px;
        margin: 15px 0;
        font-size: 22px;
        font-weight: bold;
        background: rgba(30, 144, 255, 0.1);
        padding: 15px 20px;
        border-radius: 15px;
        border: 2px solid rgba(65, 105, 225, 0.3);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      #gameInfo {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 10px 0;
        font-size: 16px;
        font-weight: bold;
      }

      #level,
      #difficulty {
        background: rgba(65, 105, 225, 0.2);
        padding: 8px 15px;
        border-radius: 20px;
        border: 1px solid rgba(65, 105, 225, 0.4);
      }

      canvas {
        background: linear-gradient(45deg, #1a237e, #283593, #3949ab);
        border: 4px solid #4169e1;
        border-radius: 15px;
        box-shadow: 0 0 30px rgba(65, 105, 225, 0.4),
          inset 0 0 20px rgba(0, 0, 0, 0.2);
        transition: box-shadow 0.3s ease;
      }

      canvas:hover {
        box-shadow: 0 0 40px rgba(65, 105, 225, 0.6),
          inset 0 0 20px rgba(0, 0, 0, 0.2);
      }

      #gameOverScreen,
      #mainMenuScreen,
      #countdownScreen {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #e0f2ff;
        background: linear-gradient(
          135deg,
          rgba(10, 20, 40, 0.95),
          rgba(30, 58, 95, 0.95)
        );
        padding: 30px;
        border-radius: 20px;
        border: 3px solid #4169e1;
        box-shadow: 0 0 50px rgba(65, 105, 225, 0.5);
        backdrop-filter: blur(15px);
        animation: screenFade 0.5s ease-in-out;
        z-index: 1000;
      }

      #mainMenuScreen {
        padding: 40px;
        min-width: 400px;
      }

      #countdownScreen {
        font-size: 2em;
        padding: 50px;
      }

      @keyframes screenFade {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      #gameOverScreen h1 {
        font-size: 2.5em;
        margin: 0 0 20px 0;
        text-shadow: 0 0 20px #ff4444;
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      #gameOverScreen button {
        background: linear-gradient(45deg, #4169e1, #1e90ff);
        color: white;
        padding: 15px 30px;
        font-size: 18px;
        font-weight: bold;
        border: none;
        border-radius: 25px;
        margin: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(65, 105, 225, 0.3);
      }

      #gameOverScreen button:hover {
        background: linear-gradient(45deg, #1e90ff, #00bfff);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(65, 105, 225, 0.5);
      }

      .menu-button {
        background: linear-gradient(45deg, #4169e1, #1e90ff);
        color: white;
        padding: 15px 30px;
        font-size: 18px;
        font-weight: bold;
        border: none;
        border-radius: 25px;
        margin: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(65, 105, 225, 0.3);
        min-width: 200px;
      }

      .menu-button:hover {
        background: linear-gradient(45deg, #1e90ff, #00bfff);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(65, 105, 225, 0.5);
      }

      .level-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 20px 0;
      }

      .level-button {
        background: linear-gradient(45deg, #4169e1, #1e90ff);
        color: white;
        padding: 20px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(65, 105, 225, 0.3);
        position: relative;
      }

      .level-button:hover {
        background: linear-gradient(45deg, #1e90ff, #00bfff);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(65, 105, 225, 0.5);
      }

      .level-button.locked {
        background: linear-gradient(45deg, #666, #888);
        cursor: not-allowed;
        opacity: 0.6;
      }

      .level-button.locked:hover {
        transform: none;
        box-shadow: 0 4px 15px rgba(65, 105, 225, 0.3);
      }

      .countdown-number {
        font-size: 8em;
        font-weight: bold;
        text-shadow: 0 0 30px #4169e1;
        animation: countdownPulse 1s ease-in-out;
      }

      @keyframes countdownPulse {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Mobile Controls */
      #controls {
        display: none;
        grid-template-columns: 60px 60px 60px;
        gap: 15px;
        margin-top: 20px;
        user-select: none;
      }

      .btn {
        width: 60px;
        height: 60px;
        background: linear-gradient(
          45deg,
          rgba(65, 105, 225, 0.3),
          rgba(30, 144, 255, 0.3)
        );
        color: #e0f2ff;
        font-size: 24px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 15px;
        border: 2px solid rgba(65, 105, 225, 0.5);
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .btn:hover,
      .btn:active {
        background: linear-gradient(
          45deg,
          rgba(65, 105, 225, 0.6),
          rgba(30, 144, 255, 0.6)
        );
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(65, 105, 225, 0.5);
      }

      @media (max-width: 500px) {
        #controls {
          display: grid;
        }
        #scoreBoard {
          width: 90%;
          font-size: 18px;
        }
        #title {
          font-size: 2em;
        }
      }

      /* Particle effect for snake movement */
      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: #4169e1;
        border-radius: 50%;
        pointer-events: none;
        animation: particle 1s ease-out forwards;
      }

      @keyframes particle {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          opacity: 0;
          transform: scale(0) translateY(-20px);
        }
      }
    </style>
  </head>
  <body>
    <h1 id="title">üêç ULTIMATE SNAKE</h1>

    <!-- Main Menu Screen -->
    <div id="mainMenuScreen">
      <h1>üêç ULTIMATE SNAKE</h1>
      <div style="margin: 30px 0">
        <button class="menu-button" onclick="showLevelSelect()">
          üéÆ Play Game
        </button>
        <button class="menu-button" onclick="showDifficultySelect()">
          ‚öôÔ∏è Difficulty
        </button>
        <button class="menu-button" onclick="showHighScores()">
          üèÜ High Scores
        </button>
      </div>
    </div>

    <!-- Level Selection Screen -->
    <div
      id="levelSelectScreen"
      style="
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #e0f2ff;
        background: linear-gradient(
          135deg,
          rgba(10, 20, 40, 0.95),
          rgba(30, 58, 95, 0.95)
        );
        padding: 40px;
        border-radius: 20px;
        border: 3px solid #4169e1;
        box-shadow: 0 0 50px rgba(65, 105, 225, 0.5);
        backdrop-filter: blur(15px);
        z-index: 1000;
        min-width: 500px;
      "
    >
      <h2>Select Starting Level</h2>
      <div class="level-grid" id="levelGrid">
        <!-- Levels will be generated by JavaScript -->
      </div>
      <button class="menu-button" onclick="showMainMenu()">
        üîô Back to Menu
      </button>
    </div>

    <!-- Countdown Screen -->
    <div id="countdownScreen">
      <div>Game Starting In...</div>
      <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <div id="difficultySelector">
      <label for="difficulty">Difficulty:</label>
      <select id="difficulty" onchange="changeDifficulty()">
        <option value="easy">üü¢ Easy</option>
        <option value="medium" selected>üü° Medium</option>
        <option value="hard">üî¥ Hard</option>
        <option value="insane">üíÄ Insane</option>
      </select>
    </div>

    <div id="scoreBoard">
      <div id="score">Score: 0</div>
      <div id="highScore">High Score: 0</div>
    </div>

    <div id="gameInfo">
      <div id="level">Level: 1</div>
      <div id="difficulty-display">Mode: Medium</div>
    </div>

    <canvas id="gameCanvas" width="440" height="440"></canvas>

    <div id="gameOverScreen">
      <h1>üíÄ GAME OVER!</h1>
      <p id="finalScore"></p>
      <p id="levelReached"></p>
      <button onclick="restartGame()">üîÑ Play Again</button>
      <button onclick="mainMenu()">üè† Main Menu</button>
    </div>

    <!-- Mobile Controls -->
    <div id="controls">
      <div></div>
      <div class="btn" id="up">‚Üë</div>
      <div></div>
      <div class="btn" id="left">‚Üê</div>
      <div class="btn" id="down">‚Üì</div>
      <div class="btn" id="right">‚Üí</div>
    </div>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const scoreDisplay = document.getElementById("score");
      const highScoreDisplay = document.getElementById("highScore");
      const levelDisplay = document.getElementById("level");
      const difficultyDisplay = document.getElementById("difficulty-display");
      const gameOverScreen = document.getElementById("gameOverScreen");
      const mainMenuScreen = document.getElementById("mainMenuScreen");
      const levelSelectScreen = document.getElementById("levelSelectScreen");
      const countdownScreen = document.getElementById("countdownScreen");
      const finalScoreText = document.getElementById("finalScore");
      const levelReachedText = document.getElementById("levelReached");

      const box = 20;
      let snake, direction, food, score, game, speed, level, obstacles, powerUp;
      let currentDifficulty = "medium";
      let animationFrame = 0;
      let particles = [];
      let gameState = "menu"; // "menu", "levelSelect", "countdown", "playing", "gameOver"
      let selectedStartLevel = 1;
      let maxUnlockedLevel = 1;

      // Smooth movement variables
      let snakePositions = [];
      let moveProgress = 0;
      let lastMoveTime = 0;

      // Difficulty settings
      const difficulties = {
        easy: {
          baseSpeed: 150,
          obstacleMultiplier: 0.5,
          speedIncrease: 5,
          powerUpChance: 0.3,
        },
        medium: {
          baseSpeed: 120,
          obstacleMultiplier: 1,
          speedIncrease: 8,
          powerUpChance: 0.2,
        },
        hard: {
          baseSpeed: 90,
          obstacleMultiplier: 1.5,
          speedIncrease: 12,
          powerUpChance: 0.15,
        },
        insane: {
          baseSpeed: 60,
          obstacleMultiplier: 2,
          speedIncrease: 15,
          powerUpChance: 0.1,
        },
      };

      let highScore = localStorage.getItem("snakeHighScore") || 0;
      maxUnlockedLevel = parseInt(localStorage.getItem("snakeMaxLevel")) || 1;
      highScoreDisplay.textContent = "High Score: " + highScore;

      document.addEventListener("keydown", setDirection);

      // Mobile buttons
      document
        .getElementById("up")
        .addEventListener("click", () => changeDir("UP"));
      document
        .getElementById("down")
        .addEventListener("click", () => changeDir("DOWN"));
      document
        .getElementById("left")
        .addEventListener("click", () => changeDir("LEFT"));
      document
        .getElementById("right")
        .addEventListener("click", () => changeDir("RIGHT"));

      function changeDifficulty() {
        currentDifficulty = document.getElementById("difficulty").value;
        const difficultyNames = {
          easy: "üü¢ Easy",
          medium: "üü° Medium",
          hard: "üî¥ Hard",
          insane: "üíÄ Insane",
        };
        difficultyDisplay.textContent =
          "Mode: " + difficultyNames[currentDifficulty];
      }

      function showMainMenu() {
        gameState = "menu";
        hideAllScreens();
        mainMenuScreen.style.display = "block";
        document.getElementById("title").style.display = "block";
        document.getElementById("difficultySelector").style.display = "none";
        document.getElementById("scoreBoard").style.display = "none";
        document.getElementById("gameInfo").style.display = "none";
        canvas.style.display = "none";
        document.getElementById("controls").style.display = "none";
      }

      function showLevelSelect() {
        gameState = "levelSelect";
        hideAllScreens();
        levelSelectScreen.style.display = "block";
        generateLevelGrid();
      }

      function showDifficultySelect() {
        // For now, just show an alert - could be expanded to a full screen
        alert("Change difficulty using the dropdown in game!");
      }

      function showHighScores() {
        alert(
          `High Score: ${highScore}\nMax Level Reached: ${maxUnlockedLevel}`
        );
      }

      function generateLevelGrid() {
        const levelGrid = document.getElementById("levelGrid");
        levelGrid.innerHTML = "";

        for (let i = 1; i <= 15; i++) {
          const levelButton = document.createElement("button");
          levelButton.className = "level-button";
          levelButton.textContent = `Level ${i}`;

          if (i <= maxUnlockedLevel) {
            levelButton.onclick = () => selectLevel(i);
          } else {
            levelButton.classList.add("locked");
            levelButton.innerHTML = `Level ${i}<br>üîí`;
          }

          levelGrid.appendChild(levelButton);
        }
      }

      function selectLevel(levelNum) {
        selectedStartLevel = levelNum;
        hideAllScreens();
        startCountdown();
      }

      function startCountdown() {
        gameState = "countdown";
        countdownScreen.style.display = "block";

        let countdown = 3;
        const countdownNumber = document.getElementById("countdownNumber");

        const countdownInterval = setInterval(() => {
          countdownNumber.textContent = countdown;
          countdownNumber.style.animation = "none";
          setTimeout(() => {
            countdownNumber.style.animation = "countdownPulse 1s ease-in-out";
          }, 10);

          countdown--;

          if (countdown < 0) {
            clearInterval(countdownInterval);
            countdownScreen.style.display = "none";
            startGame();
          }
        }, 1000);
      }

      function startGame() {
        gameState = "playing";
        document.getElementById("title").style.display = "none";
        document.getElementById("difficultySelector").style.display = "flex";
        document.getElementById("scoreBoard").style.display = "flex";
        document.getElementById("gameInfo").style.display = "flex";
        canvas.style.display = "block";

        // Show mobile controls on small screens
        if (window.innerWidth <= 500) {
          document.getElementById("controls").style.display = "grid";
        }

        initGame();
      }

      function hideAllScreens() {
        mainMenuScreen.style.display = "none";
        levelSelectScreen.style.display = "none";
        countdownScreen.style.display = "none";
        gameOverScreen.style.display = "none";
      }

      function mainMenu() {
        if (game) {
          cancelAnimationFrame(game);
        }
        showMainMenu();
      }

      function initGame() {
        snake = [{ x: 10 * box, y: 10 * box }];
        direction = "RIGHT";
        score = 0;
        level = selectedStartLevel; // Start at selected level
        obstacles = [];
        powerUp = null;
        particles = [];
        animationFrame = 0;

        // Reset smooth movement variables
        snakePositions = [...snake];
        moveProgress = 0;
        lastMoveTime = 0;

        const diff = difficulties[currentDifficulty];
        // Adjust speed based on starting level
        speed = Math.max(
          30,
          diff.baseSpeed - (selectedStartLevel - 1) * diff.speedIncrease
        );

        scoreDisplay.textContent = "Score: 0";
        levelDisplay.textContent = "Level: " + level;
        gameOverScreen.style.display = "none";

        // Initialize obstacles first, then food
        spawnObstacles();
        food = randomFood();

        // Use requestAnimationFrame for smooth movement instead of setInterval
        game = requestAnimationFrame(gameLoop);
      }

      function setDirection(event) {
        if (gameState !== "playing") return; // Only accept input during gameplay

        if (event.key === "ArrowLeft") changeDir("LEFT");
        if (event.key === "ArrowUp") changeDir("UP");
        if (event.key === "ArrowRight") changeDir("RIGHT");
        if (event.key === "ArrowDown") changeDir("DOWN");
        if (event.key === " ") event.preventDefault(); // Prevent spacebar scrolling
        if (event.key === "Escape") {
          if (gameState === "playing") {
            mainMenu();
          }
        }
      }

      function changeDir(newDir) {
        if (gameState !== "playing") return; // Only accept input during gameplay

        if (newDir === "LEFT" && direction !== "RIGHT") direction = "LEFT";
        if (newDir === "RIGHT" && direction !== "LEFT") direction = "RIGHT";
        if (newDir === "UP" && direction !== "DOWN") direction = "UP";
        if (newDir === "DOWN" && direction !== "UP") direction = "DOWN";
      }

      function randomPosition() {
        const margin = box * 2; // Keep 2 box lengths away from edges
        return {
          x:
            Math.floor(Math.random() * ((canvas.width - margin * 2) / box)) *
              box +
            margin,
          y:
            Math.floor(Math.random() * ((canvas.height - margin * 2) / box)) *
              box +
            margin,
        };
      }

      function randomFood() {
        let newFood;
        do {
          newFood = randomPosition();
        } while (
          collision(newFood.x, newFood.y, snake) ||
          collision(newFood.x, newFood.y, obstacles)
        );
        return newFood;
      }

      function spawnObstacles() {
        obstacles = [];
        const diff = difficulties[currentDifficulty];
        const obstacleCount = Math.floor((level + 2) * diff.obstacleMultiplier);

        for (let i = 0; i < obstacleCount; i++) {
          let obstacle;
          do {
            obstacle = randomPosition();
          } while (
            collision(obstacle.x, obstacle.y, snake) ||
            collision(obstacle.x, obstacle.y, obstacles) ||
            (food && obstacle.x === food.x && obstacle.y === food.y)
          );
          obstacles.push(obstacle);
        }
      }

      function spawnPowerUp() {
        const diff = difficulties[currentDifficulty];
        if (Math.random() < diff.powerUpChance) {
          do {
            powerUp = randomPosition();
          } while (
            collision(powerUp.x, powerUp.y, snake) ||
            collision(powerUp.x, powerUp.y, obstacles) ||
            (food && powerUp.x === food.x && powerUp.y === food.y)
          );
          setTimeout(() => (powerUp = null), 8000); // disappears after 8s
        }
      }

      function createParticle(x, y, color = "#4169e1") {
        particles.push({
          x: x + Math.random() * box,
          y: y + Math.random() * box,
          vx: (Math.random() - 0.5) * 4,
          vy: (Math.random() - 0.5) * 4,
          life: 30,
          maxLife: 30,
          color: color,
        });
      }

      function updateParticles() {
        particles = particles.filter((particle) => {
          particle.x += particle.vx;
          particle.y += particle.vy;
          particle.life--;
          return particle.life > 0;
        });
      }

      function drawParticles() {
        particles.forEach((particle) => {
          const alpha = particle.life / particle.maxLife;
          ctx.save();
          ctx.globalAlpha = alpha;
          ctx.fillStyle = particle.color;
          ctx.fillRect(particle.x, particle.y, 3, 3);
          ctx.restore();
        });
      }

      function gameLoop(currentTime) {
        if (currentTime - lastMoveTime >= speed) {
          update();
          lastMoveTime = currentTime;
        }
        draw();
        game = requestAnimationFrame(gameLoop);
      }

      function update() {
        // Snake movement logic
        let headX = snake[0].x;
        let headY = snake[0].y;

        if (direction === "LEFT") headX -= box;
        if (direction === "RIGHT") headX += box;
        if (direction === "UP") headY -= box;
        if (direction === "DOWN") headY += box;

        // Game Over conditions
        if (
          headX < 0 ||
          headX >= canvas.width ||
          headY < 0 ||
          headY >= canvas.height ||
          collision(headX, headY, snake) ||
          collision(headX, headY, obstacles)
        ) {
          endGame();
          return;
        }

        // Eat food
        if (headX === food.x && headY === food.y) {
          score++;
          scoreDisplay.textContent = "Score: " + score;

          // Create food particles
          for (let i = 0; i < 8; i++) {
            createParticle(food.x, food.y, "#ff4444");
          }

          // Spawn power-up based on difficulty
          if (score % 5 === 0 && !powerUp) spawnPowerUp();

          // Level up every 10 points
          if (score % 10 === 0) {
            level++;
            levelDisplay.textContent = "Level: " + level;

            const diff = difficulties[currentDifficulty];
            speed = Math.max(30, speed - diff.speedIncrease);
            spawnObstacles();

            // Level up particles
            for (let i = 0; i < 20; i++) {
              createParticle(
                Math.random() * canvas.width,
                Math.random() * canvas.height,
                "#ffd700"
              );
            }
          }

          if (score > highScore) {
            highScore = score;
            localStorage.setItem("snakeHighScore", highScore);
            highScoreDisplay.textContent = "High Score: " + highScore;
          }

          // Update max unlocked level
          if (level > maxUnlockedLevel) {
            maxUnlockedLevel = level;
            localStorage.setItem("snakeMaxLevel", maxUnlockedLevel);
          }

          food = randomFood();
        } else {
          snake.pop();
        }

        // Eat power-up
        if (powerUp && headX === powerUp.x && headY === powerUp.y) {
          score += 5; // increased bonus points
          powerUp = null;
          scoreDisplay.textContent = "Score: " + score;

          // Power-up particles
          for (let i = 0; i < 15; i++) {
            createParticle(headX, headY, "#ffd700");
          }
        }

        // Add new head
        const newHead = { x: headX, y: headY };
        snake.unshift(newHead);

        // Update positions for smooth movement
        snakePositions = [...snake];
      }

      function draw() {
        animationFrame++;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Dynamic background based on level and difficulty
        const bgColor1 =
          level % 3 === 0 ? "#1a237e" : level % 3 === 1 ? "#283593" : "#3949ab";
        const bgColor2 =
          level % 3 === 0 ? "#283593" : level % 3 === 1 ? "#3949ab" : "#5e72e4";

        const gradient = ctx.createLinearGradient(
          0,
          0,
          canvas.width,
          canvas.height
        );
        gradient.addColorStop(0, bgColor1);
        gradient.addColorStop(1, bgColor2);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Update and draw particles
        updateParticles();
        drawParticles();

        // Create movement particles
        if (animationFrame % 3 === 0) {
          createParticle(snake[0].x, snake[0].y, "#00ff41");
        }

        // Draw snake with enhanced graphics and smooth interpolation
        for (let i = 0; i < snake.length; i++) {
          let drawX = snake[i].x;
          let drawY = snake[i].y;

          // Smooth interpolation for movement (subtle effect)
          if (i === 0 && snakePositions.length > 0) {
            const timeSinceLastMove = Date.now() - lastMoveTime;
            const interpolationFactor = Math.min(timeSinceLastMove / speed, 1);

            // Very subtle smoothing - just reduces jerkiness
            const smoothOffset = (1 - interpolationFactor) * 2;
            if (direction === "RIGHT") drawX -= smoothOffset;
            else if (direction === "LEFT") drawX += smoothOffset;
            else if (direction === "DOWN") drawY -= smoothOffset;
            else if (direction === "UP") drawY += smoothOffset;
          }

          // Snake body gradient
          const bodyGradient = ctx.createRadialGradient(
            drawX + box / 2,
            drawY + box / 2,
            0,
            drawX + box / 2,
            drawY + box / 2,
            box / 2
          );

          if (i === 0) {
            // Head
            bodyGradient.addColorStop(0, "#00ff41");
            bodyGradient.addColorStop(1, "#00cc33");

            // Add glow effect to head
            ctx.shadowBlur = 15;
            ctx.shadowColor = "#00ff41";
          } else {
            // Body
            const intensity = 1 - (i / snake.length) * 0.5;
            bodyGradient.addColorStop(0, `rgba(0, 255, 65, ${intensity})`);
            bodyGradient.addColorStop(1, `rgba(0, 204, 51, ${intensity})`);
            ctx.shadowBlur = 5;
            ctx.shadowColor = "#00ff41";
          }

          ctx.fillStyle = bodyGradient;
          ctx.fillRect(drawX, drawY, box, box);

          // Snake head details
          if (i === 0) {
            ctx.shadowBlur = 0;
            // Eyes
            ctx.fillStyle = "#000";
            ctx.fillRect(drawX + 4, drawY + 4, 4, 4);
            ctx.fillRect(drawX + 12, drawY + 4, 4, 4);

            // Eye glow
            ctx.fillStyle = "#ff0000";
            ctx.fillRect(drawX + 5, drawY + 5, 2, 2);
            ctx.fillRect(drawX + 13, drawY + 5, 2, 2);
          }
        }
        ctx.shadowBlur = 0;

        // Draw food with pulsing effect
        const foodPulse = Math.sin(animationFrame * 0.2) * 0.3 + 1;
        ctx.save();
        ctx.translate(food.x + box / 2, food.y + box / 2);
        ctx.scale(foodPulse, foodPulse);

        const foodGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, box / 2);
        foodGradient.addColorStop(0, "#ff4444");
        foodGradient.addColorStop(0.7, "#ff0000");
        foodGradient.addColorStop(1, "#cc0000");

        ctx.shadowBlur = 20;
        ctx.shadowColor = "#ff0000";
        ctx.fillStyle = foodGradient;
        ctx.fillRect(-box / 2, -box / 2, box, box);
        ctx.restore();

        // Draw obstacles with blue theme
        obstacles.forEach((o) => {
          const obstacleGradient = ctx.createLinearGradient(
            o.x,
            o.y,
            o.x + box,
            o.y + box
          );
          obstacleGradient.addColorStop(0, "#4169e1");
          obstacleGradient.addColorStop(1, "#1e3a8a");

          ctx.fillStyle = obstacleGradient;
          ctx.fillRect(o.x, o.y, box, box);

          // Add border
          ctx.strokeStyle = "#60a5fa";
          ctx.lineWidth = 2;
          ctx.strokeRect(o.x, o.y, box, box);
        });

        // Draw powerUp with rotating effect
        if (powerUp) {
          ctx.save();
          ctx.translate(powerUp.x + box / 2, powerUp.y + box / 2);
          ctx.rotate(animationFrame * 0.1);

          const powerGradient = ctx.createRadialGradient(
            0,
            0,
            0,
            0,
            0,
            box / 2
          );
          powerGradient.addColorStop(0, "#ffd700");
          powerGradient.addColorStop(0.7, "#ffff00");
          powerGradient.addColorStop(1, "#ffa500");

          ctx.shadowBlur = 25;
          ctx.shadowColor = "#ffd700";
          ctx.fillStyle = powerGradient;
          ctx.beginPath();
          ctx.arc(0, 0, box / 2, 0, Math.PI * 2);
          ctx.fill();

          // Star shape
          ctx.fillStyle = "#ffffff";
          for (let i = 0; i < 8; i++) {
            ctx.rotate(Math.PI / 4);
            ctx.fillRect(-1, -box / 3, 2, box / 6);
          }
          ctx.restore();
        }
      }

      function collision(x, y, array) {
        if (!array || array.length === 0) return false;
        for (let i = 0; i < array.length; i++) {
          if (x === array[i].x && y === array[i].y) return true;
        }
        return false;
      }

      function endGame() {
        gameState = "gameOver";
        cancelAnimationFrame(game);

        // Create explosion particles
        for (let i = 0; i < 30; i++) {
          createParticle(
            snake[0].x + Math.random() * box,
            snake[0].y + Math.random() * box,
            "#ff0000"
          );
        }

        finalScoreText.textContent = "Your Score: " + score;
        levelReachedText.textContent = "Level Reached: " + level;

        // Delay showing game over screen for explosion effect
        setTimeout(() => {
          gameOverScreen.style.display = "block";
        }, 500);
      }

      function restartGame() {
        hideAllScreens();
        startCountdown();
      }

      // Initialize the game
      changeDifficulty(); // Set initial difficulty display
      showMainMenu(); // Start with main menu instead of immediately starting game
    </script>
  </body>
</html>
